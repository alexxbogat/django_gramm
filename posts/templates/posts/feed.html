{% extends 'base.html' %}
{% load static %}
{% load cloudinary %}

{% block css_icon %}
    <!-- ICON LIBRARY -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
    <!-- MAIN CONTAINER -->
    <div class="container apple-style">
        <!-- PAGE TITLE -->
        <h2 class="page-title">Latest Posts</h2>

        <!-- POST GRID -->
        <div class="post-grid">
            {% for post in posts %}
                <!-- SINGLE POST CARD -->
                <div class="post-card white-card">

                    <!-- POST IMAGES -->
                    {% if post.images.all %}
                        <div class="post-images-grid">
                            {% for image in post.images.all %}
                                {% cloudinary image.file quality='auto' width=700 crop='pad' background='gen_fill:ignore-foreground_true' alt="Post Image" class="post-image-multi" %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- POST CONTENT -->
                    <div class="post-card-content">

                        <!-- POST HEADER: USER INFO + TIMESTAMP -->
                        <div class="post-header">
                            <a href="{% url 'profile' post.user.username %}" class="post-user-info">
                                {% if post.user.profile.avatar.file %}
                                    {% cloudinary post.user.profile.avatar.file quality='auto' width=150 height=150 crop='pad' background='gen_fill:ignore-foreground_true' class="feed-avatar" alt="Avatar" %}
                                {% else %}
                                    <img src="{% static 'img/users/default_avatar.jpg' %}" class="feed-avatar" alt="Default Avatar">
                                {% endif %}
                                <div class="user-details">
                                    <span class="username">{{ post.user.username }}</span>
                                </div>
                            </a>
                            <span class="timestamp">{{ post.created_at|date:"d M Y H:i" }}</span>
                        </div>

                        <!-- POST TEXT -->
                        <p class="post-text">{{ post.text }}</p>

                        <!-- POST TAGS -->
                        {% if post.tags.all %}
                            <div class="tag-container">
                                {% for tag in post.tags.all %}
                                    <span class="tag">#{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- ADD TAGS FORM (ONLY POST OWNER) -->
                        {% if request.user == post.user %}
                            <form action="{% url 'add_tags' post.id %}" method="post" class="tag-form">
                                {% csrf_token %}
                                <input type="text" name="tags" placeholder="Add tags, separated by comma" class="tag-input">
                                <button type="submit" class="btn apple-btn small-btn">Add</button>
                            </form>
                        {% endif %}

                        <!-- LIKE BUTTON -->
                        <button class="like-btn {% if post.liked_by_user %}liked{% else %}not-liked{% endif %}"
                                data-post-id="{{ post.id }}">
                            <i class="{% if post.liked_by_user %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span class="like-count">{{ post.likes.count }}</span>
                        </button>

                        <!-- DELETE POST BUTTON (ONLY POST OWNER) -->
                        {% if request.user == post.user %}
                            <form action="{% url 'delete_post' post.id %}" method="post" class="delete-form">
                                {% csrf_token %}
                                <button type="submit" class="btn delete-btn" title="Delete post">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% endif %}

                        <!-- EDIT POST BUTTON (ONLY POST OWNER) -->
                        {% if request.user == post.user %}
                            <a href="{% url 'edit_post' post.id %}" class="btn apple-btn small-btn">Edit</a>
                        {% endif %}
                    </div> <!-- END POST CONTENT -->
                </div> <!-- END SINGLE POST CARD -->
            {% endfor %}
        </div> <!-- END POST GRID -->
    </div> <!-- END MAIN CONTAINER -->
{% endblock %}
