{% extends 'base.html' %}
{% load cloudinary %}
{% load static %}

{% block css_icon %}
    <!-- ICON STYLES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
    <div class="container profile-container apple-style">

        <!-- PROFILE HEADER -->
        <div class="profile-header">
            <!-- AVATAR -->
            {% if user.profile.avatar %}
                {% cloudinary user.profile.avatar.file quality='auto' width=150 height=150 crop='pad' background='gen_fill:ignore-foreground_true' class="profile-avatar" alt="Avatar" %}
            {% else %}
                <img src="{% static 'img/users/default_avatar.jpg' %}" class="profile-avatar" alt="Default Avatar">
            {% endif %}

            <!-- PROFILE INFO -->
            <div class="profile-info">
                <h2 class="username">@{{ user.username }}</h2>
                {% if user.first_name or user.last_name %}
                    <p class="full-name">{{ user.first_name }} {{ user.last_name }}</p>
                {% endif %}

                <!-- FOLLOW BUTTON -->
                {% if request.user != user %}
                    <form action="{% url 'subscribe' user.id %}" method="post" class="follow-form">
                        {% csrf_token %}
                        <button type="submit" class="btn apple-btn {% if is_following %}unfollow{% endif %}"
                                data-author-id="{{ user.id }}">
                            {% if is_following %}Unsubscribe{% else %}Subscribe{% endif %}
                        </button>
                    </form>
                {% endif %}

                <!-- PROFILE STATS -->
                <div class="profile-stats">
                    <a href="{% url 'followers_list' user.username %}" class="stat stat-link">
                        <span class="stat-count">{{ user.followers.count }}</span>
                        <span class="stat-label">Followers</span>
                    </a>
                    <a href="{% url 'following_list' user.username %}" class="stat stat-link">
                        <span class="stat-count">{{ user.following.count }}</span>
                        <span class="stat-label">Following</span>
                    </a>
                </div>

                <!-- BIO -->
                {% if user.profile.description %}
                    <p class="bio">{{ user.profile.description }}</p>
                {% endif %}

                <!-- EDIT PROFILE BUTTON -->
                {% if is_owner %}
                    <a href="{% url 'edit_profile' user.username %}" class="btn apple-btn">Edit Profile</a>
                {% endif %}
            </div>
        </div>

        <!-- USER POSTS -->
        <h3 class="page-title">{{ user.username }}'s Posts</h3>
        <div class="post-grid">
            {% for post in posts %}
                <div class="post-card white-card">

                    <!-- POST IMAGES -->
                    {% if post.images.all %}
                        <div class="post-images-grid">
                            {% for image in post.images.all %}
                                {% cloudinary image.file quality='auto' width=700 crop='pad' background='gen_fill:ignore-foreground_true' alt="Post Image" class="post-image-multi" %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- POST CONTENT -->
                    <div class="post-card-content">

                        <!-- TIMESTAMP -->
                        <div class="post-header">
                            <span class="timestamp">{{ post.created_at|date:"d M Y, H:i" }}</span>
                        </div>

                        <!-- TEXT -->
                        <p class="post-text">{{ post.text|linebreaksbr }}</p>

                        <!-- TAGS -->
                        {% if post.tags.all %}
                            <div class="tag-container">
                                {% for tag in post.tags.all %}
                                    <span class="tag">#{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- ADD TAGS FORM -->
                        {% if request.user == post.user %}
                            <form action="{% url 'add_tags' post.id %}" method="post" class="tag-form">
                                {% csrf_token %}
                                <input type="text" name="tags" placeholder="Add tags, separated by comma"
                                       class="tag-input">
                                <button type="submit" class="btn apple-btn small-btn">Add</button>
                            </form>
                        {% endif %}

                        <!-- LIKE BUTTON -->
                        <button class="like-btn {% if post.is_liked %}liked{% else %}not-liked{% endif %}"
                                data-post-id="{{ post.id }}">
                            <i class="{% if post.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span class="like-count">{{ post.likes.count }}</span>
                        </button>

                        <!-- DELETE POST -->
                        {% if request.user == post.user %}
                            <form action="{% url 'delete_post' post.id %}" method="post" class="delete-form">
                                {% csrf_token %}
                                <button type="submit" class="btn delete-btn" title="Delete post">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        {% endif %}

                        <!-- EDIT POST -->
                        {% if request.user == post.user %}
                            <a href="{% url 'edit_post' post.id %}" class="btn apple-btn small-btn">Edit</a>
                        {% endif %}

                    </div>
                </div>
            {% empty %}
                <p>You haven't posted anything yet.</p>
            {% endfor %}
        </div>
    </div>
{% endblock %}
